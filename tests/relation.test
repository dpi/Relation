<?php

/**
 * @file
 * Tests for Relation module.
 */

/**
 * Test relation.
 */
class RelationTestCase extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Relation test',
      'description' => 'Test relations.',
      'group' => 'Relation',
    );
  }

  function setUp() {
    parent::setUp('relation');
    $perms = array(
      'create article content',
      'create page content',
      'administer relation types',
      'create relations',
      'edit relations',
      'delete relations',
      );
    $web_user = $this->drupalCreateUser($perms);
    $this->drupalLogin($web_user);
  }

  /**
   * Create some nodes, add some relations and check they are related.
   */
  function testRelationCRDMultiple() {
    $node1 = $this->drupalCreateNode(array('type' => 'article', 'promote' => 1));
    $node2 = $this->drupalCreateNode(array('type' => 'article', 'promote' => 1));
    $node3 = $this->drupalCreateNode(array('type' => 'article', 'promote' => 0));
    $node4 = $this->drupalCreateNode(array('type' => 'page', 'promote' => 0));

    $this->createRelationTypes();
    $predicate_sym = 'symmetric';
    $predicate_dir = 'directional';
    $predicate_octo = 'octopus';
    $errors = array();

    // create a symmetric relation
    $entity_keys = array(
      array(
        'entity_type' => 'node',
        'entity_id' => $node1->nid,
      ),
      array(
        'entity_type' => 'node',
        'entity_id' => $node4->nid,
      )
    );
    $this->RelationSaveHelper($predicate_sym, $entity_keys);
    $relations = relation_query('node', $node4->nid)->execute();
    $count = count($relations);
    $this->assertEqual(count($relations), 1, $count . ' relation found, should be 1');
    $relation = reset($relations);
    $this->assertEqual($relation->entity_keys[0]['entity_id'], $node1->nid, 'Correct entity is related: ' . $relation->entity_keys[0]['entity_id'] . '==' . $node1->nid);
  }

  function RelationSaveHelper($predicate, $entity_keys) {
      relation_validate($predicate, $entity_keys, $errors);
    if ($errors) {
      foreach ($errors as $error) {
        $this->fail($error);
      }
    }
    else {
      $this->pass('Validation passed');
    }
    $rid = relation_create($predicate, $entity_keys);
    $relation = relation_load($rid);
    $count = count($relation->entity_keys);
    $this->assertEqual($count, 2, 'There are two entities: ' . $count);
    $this->assertEqual($relation->arity, 2, 'Arity is 2: ' . $relation->arity);
    $this->assertEqual($relation->predicate, $predicate, 'Predicate is correct: ' . $relation->predicate);
    foreach ($entity_keys as $entity_key) {
      $need_ids[$entity_key['entity_id']] = TRUE;
    }
    foreach ($relation->entity_keys as $entity_key) {
      $this->assertEqual($entity_key['entity_type'], 'node', 'The entity type is node: ' . $entity_key['entity_type']);
      $this->assertTrue(isset($need_ids[$entity_key['entity_id']]), 'The entity ID is correct: ' . $need_ids[$entity_key['entity_id']]);
      unset($need_ids[$entity_key['entity_id']]);
    }
    $this->assertFalse($need_ids, 'All ids found');
  }

  function createRelationTypes() {
    $relation_type = array(
      'predicate'   => 'symmetric',
      'label' => $this->randomString(),
      'source_bundles' => array('node:article', 'node:page'),
    );
    relation_type_save($relation_type);
    $relation_type = array(
      'predicate'   => 'directional',
      'label' => $this->randomString(),
      'directional' => TRUE,
      'source_bundles' => array('node:article'),
      'target_bundles' => array('node:page'),
    );
    relation_type_save($relation_type);
    $relation_type = array(
      'predicate'   => 'octopus',
      'label' => $this->randomString(),
      'min_arity' => 2,
      'max_arity' => 8,
      'source_bundles' => array('node:article', 'node:page'),
    );
    relation_type_save($relation_type);
  }
}
