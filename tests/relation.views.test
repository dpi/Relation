<?php
/**
 * @file
 * Tests for Views support in the Relation module.
 */

/**
 * Functional test of Relation's integration with Views.
 */
class RelationViewsTestCase extends RelationTestCase {

  function getInfo() {
    return array(
      'name' => 'Relation Views test',
      'description' => 'Tests the Relation Views support.',
      'group' => 'Relation',
    );
  }

  function setUp() {
    parent::setUp('relation', 'views');
  }

  /**
   * Tests relations in Views.
   */
  function testRelationViews() {
    // Symmetric.
    $view = new view;

    $handler = $view->new_display('default');

    $handler->display->display_options['relationships']['relation_symmetric_node']['id'] = 'relation_symmetric_node';
    $handler->display->display_options['relationships']['relation_symmetric_node']['table'] = 'node';
    $handler->display->display_options['relationships']['relation_symmetric_node']['field'] = 'relation_symmetric_node';

    $handler->display->display_options['fields']['nid']['id'] = 'nid';
    $handler->display->display_options['fields']['nid']['table'] = 'node';
    $handler->display->display_options['fields']['nid']['field'] = 'nid';

    $handler->display->display_options['arguments']['nid']['id'] = 'nid';
    $handler->display->display_options['arguments']['nid']['table'] = 'node';
    $handler->display->display_options['arguments']['nid']['field'] = 'nid';
    $handler->display->display_options['arguments']['nid']['relationship'] = 'relation_symmetric_node';

    $view->set_arguments(array($this->node1->nid));
    $view->execute();

    $this->assertEqual(count($view->result), 1);
    $this->assertEqual($view->result[0]->nid, $this->node4->nid);

    // Directional to source, to target and to both.
    for ($r_index = -1 ; $r_index < 2; $r_index++) {
      $view = new view;

      $handler = $view->new_display('default');

      $handler->display->display_options['relationships']['relation_directional_node']['id'] = 'relation_directional_node';
      $handler->display->display_options['relationships']['relation_directional_node']['table'] = 'node';
      $handler->display->display_options['relationships']['relation_directional_node']['field'] = 'relation_directional_node';
      $handler->display->display_options['relationships']['relation_directional_node']['required'] = 1;
      $handler->display->display_options['relationships']['relation_directional_node']['r_index'] = $r_index;

      $handler->display->display_options['fields']['nid']['id'] = 'nid';
      $handler->display->display_options['fields']['nid']['table'] = 'node';
      $handler->display->display_options['fields']['nid']['field'] = 'nid';

      $handler->display->display_options['arguments']['nid']['id'] = 'nid';
      $handler->display->display_options['arguments']['nid']['table'] = 'node';
      $handler->display->display_options['arguments']['nid']['field'] = 'nid';
      $handler->display->display_options['arguments']['nid']['relationship'] = 'relation_directional_node';

      $view->set_arguments(array($this->node3->nid));
      $view->execute();

      switch ($r_index) {
        case -1:
          // Directional, both ways.
          $this->assertEqual(count($view->result), 2);
          $matches = array($this->node1->nid => TRUE, $this->node4->nid => TRUE);
          foreach ($view->result as $result) {
            unset($matches[$result->nid]);
          }
          $this->assertFalse($matches);
          break;
        case 0:
          // Source.
          // Here, because the argument is using the Views relation, it stands
          // on the opossite end of the relation and so this is backwards.
          $this->assertEqual(count($view->result), 1);
          $this->assertEqual($view->result[0]->nid, $this->node1->nid);
          break;
        case 1:
          // Target.
          $this->assertEqual(count($view->result), 1);
          $this->assertEqual($view->result[0]->nid, $this->node4->nid);
          break;
      }
    }
  }
}
