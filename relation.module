<?php

/**
 * @file
 * Describes relations between entities.
 */

/**
 * Implements hook_entity_info().
 */
function relation_entity_info() {
  return;
  $entities['relation'] = array(
    'label' => t('Relation'),
    'base table' => 'relation',
    'fieldable' => FALSE,
    'controller class' => 'RelationEntityController',
    'entity keys' => array(
      'id' => 'relation_id',
      'bundle' => 'predicate',
    ),
    'bundle keys' => array(
      'bundle' => 'predicate',
    ),
    'bundles' => array(
      // Describe Drupal's built-in relations.
      'creator' => array(
        'label' => t('Author'),
      ),
    ),
    'view modes' => array(),
  );
  return $entities;
}

/**
 * Controller class for entity relations.
 *
 * This extends the DrupalDefaultEntityController class. The buildQuery method
 * is overriden to add the self join and to exclude rows where the left and
 * right entities are identical.
 */
class RelationEntityController extends DrupalDefaultEntityController {
  protected function buildQuery($ids, $conditions = array(), $revision_id = FALSE) {
    $query = parent::buildQuery($ids, $conditions, $revision_id);
    _relation_entity_query_helper($query);
    return $query;
  }
}

function _relation_entity_query_helper($query, $table, $field_name) {
  $query->innerJoin('relation_data', 'l', 'base.relation_id = l.relation_id');
  $query->innerJoin('relation_data', 'r', 'base.relation_id = r.relation_id AND NOT (l.entity_type = r.entity_type AND l.entity_id = r.entity_id)');
  $query->addField('base', 'relation_id');
  $query->addField('base', 'predicate');
  $query->addField('l', 'entity_type', 'left_entity_type');
  $query->addField('l', 'entity_id', 'left_entity_id');
  $query->addField('r', 'entity_type', 'right_entity_type');
  $query->addField('r', 'entity_id', 'right_entity_id');
}

/**
 * Interface for relation handlers.
 */
interface RelationInterface {
  // bangpound
  public function getRelated($entity, $type);

  // becw
  function init($left, $right); // sets types
  function set_left($entity_ids = array()); // sets left objects
  function set_right($entity_ids = array()); // sets right objects
  function get_left(); // returns left
  function get_right(); // returns right
}

/**
 * Handler class for entity relations.
 */
class RelationHandler implements RelationInterface {

  function __construct() {
  }

  /**
   * Entity is a fully loaded entity (node, user, term, etc.)
   * Type is the predicate.
   */
  public function getRelated($entity, $type) {
    return NULL;
  }

  function init($left, $right) {
  }

  function set_left($entity_ids = array()) {
  }

  function set_right($entity_ids = array()) {
  }

  function get_left() {
  }

  function get_right() {
  }
}
/**
 * Create a relation.
 *
 * @param $entity_keys
 *   A list of (entity_type, entity_id) pairs.
 * @return
 *   The new relation id.
 */
function relation_create($entity_keys) {
  $relation_id = db_insert('relation')->useDefaults()->execute();
  $query = db_insert('relation_data')
    ->fields(array('relation_id', 'entity_type', 'entity_id'));
  foreach ($entity_keys as $entity_key) {
    $query->values(array($relation_id, $entity_key[0], $entity_key[1]));
  }
  $query->execute();
  return $relation_id;
}

/**
 * Implements hook_block_info().
 */
function relation_block_info() {
  return array(
    'dropzone' => array(
      'info' => t('Relation block'),
    ),
  );
}

/**
 * Implements hook_block_view().
 */
function relation_block_view() {
  $form = drupal_get_form('relation_dropzone');
  if (isset($form['entity_key'])) {
    return array(
      'subject' => t('Pick an entity'),
      'content' => $form,
    );
  }
  return array();
}

/**
 * The dropzone form.
 */
function relation_dropzone($form) {
  $options = array();
  foreach (drupal_static('relation_entities', array()) as $entity_type => $entities) {
    foreach ($entities as $entity_id => $entity) {
      $options["$entity_type:$entity_id"] = "$entity_type: " . entity_label($entity_type, $entity);
    }
  }
  if ($options) {
    $form['entity_key'] = array(
      '#type'         => 'select',
      '#options'      => $options,
    );
    if (count($options) > 1) {
      $form['#empty_value'] = '';
      $form['#empty_option'] = t('Select an entity');
    }
    $form['save'] = array(
      '#type' => 'submit',
      '#submit' => array('relation_dropzone_pick'),
      '#value' => t('Pick'),
    );
    if (!empty($_SESSION['stored_entity_keys'])) {
      $list = array();
      foreach ($_SESSION['stored_entity_keys'] as $entity_key) {
        // The structure is (entity_type, entity_id, entity label).
        $list[] = $entity_key[0] .': '. $entity_key[2];
      }
      $form['stored']['#markup'] =  array(
        '#theme' => 'item_list',
        '#items' => $list,
      );
      $form['save'] = array(
        '#type' => 'submit',
        '#value' => t('Pick'),
      );
    }
  }
  return $form;
}

/**
 * Submit handler for the pick button.
 */
function relation_dropzone_pick($form, $form_state) {
  if ($entity_key = $form_state['values']['entity_key']) {
    // Here we get (entity_type, entity_id).
    $pick = explode(':', $entity_key);
    // Add the label for later display. #options is check_plain'd but we need
    // to do that ourselves.
    $pick[] = check_plain($form['entity']['#options'][$entity_key]);
    $_SESSION += array('stored_entity_keys' => array());
    $_SESSION['stored_entity_keys'][] = $pick;
  }
}

/**
 * Submit handler for the save button.
 */
function relation_dropzone_save($form, $form_state) {
  relation_dropzone_pick($form, $form_state);
  if (isset($_SESSION['stored_entity_keys'])) {
    relation_create($_SESSION['stored_entity_keys']);
    unset($_SESSION['stored_entity_keys']);
  }
}

/**
 * Implements hook_entity_load().
 */
function relation_entity_load($entities, $type) {
  $entities_store = &drupal_static('relation_entities', array());
  $enabled = &drupal_static(__FUNCTION__);
  // Recursion protection.
  if ($enabled == -1) {
    return;
  }
  if (!isset($enabled)) {
    $enabled = -1;
    drupal_theme_initialize();
    $block_info = _block_load_blocks();
    $enabled = FALSE;
    foreach ($block_info as $region => $blocks) {
      if (isset($blocks['relation_dropzone'])) {
        $enabled = TRUE;
        break;
      }
    }    
  }
  if ($enabled) {
    $entities_store += array($type => array());
    $entities_store[$type] += $entities;
  }
}

